本次的学习目的是**详细了解NFSv3协议**，绝不能泛泛而谈，否则解决不了工作中遇到的问题。主要参考资料有以下这些。

- NFSv3 RFC Specification
- 《操作系统导论》第48章

## 一、NFS协议介绍
《操作系统导论》第48章给出了关于NFS协议的大体介绍，内容非常棒。关于其中的要点可以做如下的总结。

网络文件系统NFS属于分布式文件系统的大范畴，分布式文件系统的大体框架如下所示。NFS可以看成是一个特定的分布式文件系统，自然也是遵循下图的体系结构的。大概原理是客户端文件系统对上承接应用程序的POSIX文件系统接口，将其转换成标准的NFS消息发送给文件服务器。文件服务器根据收到的NFS消息做相应处理后将处理结果发送给客户端文件系统。核心的客户端文件系统在这里起到了两个核心作用：

（1）对上层提供POSIX语义实现，后面会讲到NFS客户端和服务器之间的交互被设计成无状态的，因此在客户端这里需要将其于服务器之间的交互包装成有状态的POSIX接口供应用程序使用

（2）将应用程序的POSIX语义的文件操作转换成NFS协议消息发送给服务端，随后将服务端的回复消息转换后提供给应用程序。

[nfs0.png](./img/nfs0.PNG)

针对分布式环境，NFSv2的设计目标可以概括成以下三个关键字。我们分别做一些总结性阐述，详细内容请参考原文《操作系统导论》。

（1）协议无状态

（2）操作幂等性

（3）缓存与缓存一致性问题

## 协议无状态
考虑到分布式环境中随时可能有服务器奔溃，需要让服务器在奔溃后立即恢复。而立即恢复的关键在于客户端和服务端之间的交互是无状态的，服务器不会记录客户端上发生的任何事情，客户端的每次请求都需要给出完成请求所需要的全部信息。不这样做会有什么后果？试想客户端在首次read调用后从服务端拿到了文件描述符，在客户端的第二次read调用之间服务端奔溃将保存在内存中的文件描述符信息丢失了，随后服务端进程重启。随后客户端拿着旧的文件描述符发来第二次read调用，请问此时服务端怎样才能知道这个旧的文件描述符对应哪个文件？

为了解决这个问题，NFS协议的设计者们采用了无状态的方式。客户端的每次请求都需要携带完成该请求的所有信息，这样服务端的奔溃恢复逻辑可以做的很简单，可能只需要重启进程即可。但这样做的代价是增大了每次操作所需的网络流量。

## 操作幂等性


## 二、NFS协议特性

